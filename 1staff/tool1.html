<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Kaartdijin Validator v0.5</title>
    <style>
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: #2196F3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            text-decoration: none;
        }

        .back-button:hover {
            background-color: #1976D2;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .upload-container {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }


        .file-inputs {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .file-drop-area {
            flex: 1;
            border: 2px dashed #ccc;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: auto;
        }

        .file-drop-area.dragover {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }

        .file-drop-area.invalid {
            border-color: #d32f2f;
            background-color: #ffebee;
        }

        .file-drop-area.valid {
            border-color: #2e7d32;
            background-color: #e8f5e9;
        }

        .file-drop-area input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-drop-area h2 {
            font-size: 1rem;
            margin: 0 0 5px 0;
        }

        .file-drop-area p {
            margin: 0;
            font-size: 0.8em;
            color: #666;
        }


        .file-error {
            color: #d32f2f;
            font-size: 0.75em;
            margin-top: 4px;
        }


        .file-drop-area.invalid .file-error {
            display: block;
        }

        .file-name {
            margin-top: 5px;
            font-size: 0.8em;
            color: #1976d2;
            word-break: break-all;
        }


        .results {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }

        .warning {
            color: #ed6c02;
            background-color: #fff4e5;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }


        .error-category,
        .warning-category {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 4px;
        }

        .error-category h3,
        .warning-category h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
        }

        button {
            background-color: #1976d2;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: block;
            margin: 0 auto;
            position: relative;
        }

        button:hover:not(:disabled) {
            background-color: #1565c0;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: white;
            text-align: center;
            border-radius: 4px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        h1,
        h2 {
            color: #333;
        }

        #errorList {
            list-style-type: none;
            padding: 0;
        }

        .success {
            color: #2e7d32;
            background-color: #e8f5e9;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }

        .summary-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }


        .total-summary {
            flex: 1;
            font-size: 1.1em;
            font-weight: bold;
            padding: 12px 15px;
            border-radius: 4px;
            background-color: #f5f5f5;
        }

        .total-errors {
            color: #d32f2f;
            border-left: 4px solid #d32f2f;
        }

        .total-warnings {
            color: #ed6c02;
            border-left: 4px solid #ed6c02;
        }


        .upload-icon {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 5px;
            display: inline-block;
        }


        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            margin: 20px auto;
            position: relative;
        }

        .help-button {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #1976d2;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-button:hover {
            background-color: #60a3e6;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #333;
        }

        .modal h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section h3 {
            color: #1976d2;
            margin-bottom: 8px;
        }

        .modal-section p {
            margin: 0;
            line-height: 1.5;
        }

        .view-toggle {
            margin-top: 10px;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            font-family: Arial, sans-serif;
        }

        .view-toggle label {
            font-size: 0.95rem;
            color: #333;
            font-weight: 500;
            font-family: Arial, sans-serif;
        }

        .view-toggle select {
            padding: 8px 32px 8px 12px;
            border-radius: 4px;
            border: 2px solid #2196F3;
            font-size: 0.95rem;
            color: #1976D2;
            font-weight: 500;
            font-family: Arial, sans-serif;
            background-color: #f8f9ff;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%232196F3' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            min-width: 150px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .view-toggle select option {
            font-family: Arial, sans-serif;
            font-size: 0.95rem;
            color: #333;
            background-color: white;
            padding: 8px;
        }

        /* Hover state */
        .view-toggle select:hover {
            border-color: #1976D2;
            background-color: #f0f7ff;
        }

        /* Focus state */
        .view-toggle select:focus {
            outline: none;
            border-color: #1976D2;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        /* Disabled state */
        .view-toggle select:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .staff-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }


        .staff-group {
            background-color: #f8f8f8;
            border-radius: 6px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .staff-group h3 {
            margin: 0 0 12px 0;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
            font-size: 1.1rem;
        }

        .staff-issues {
            margin-left: 0;
        }

        .staff-issues-section {
            margin-bottom: 12px;
        }

        .staff-issues .error,
        .staff-issues .warning {
            padding: 12px 16px;
            margin: 8px 0;
            font-size: 0.95rem;
            line-height: 1.4;
            border-radius: 6px;
        }

        .staff-issues .error {
            background-color: #fdeded;
            color: #d32f2f;
            border-left: 4px solid #d32f2f;
        }

        .staff-issues .warning {
            background-color: #fff4e5;
            color: #ed6c02;
            border-left: 4px solid #ed6c02;
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .staff-grid {
                grid-template-columns: 1fr;
            }

            .staff-group {
                padding: 14px;
            }
        }

        /* Optional hover effect for better interaction */
        .staff-group:hover {
            background-color: #f2f2f2;
            transition: background-color 0.2s ease;
        }
    </style>
</head>

<body>

    <noscript>
        <div style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
        ">
            <div style="
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            font-family: system-ui, -apple-system, sans-serif;
          ">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                    stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="margin: 0 auto 1rem auto;">
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" y1="8" x2="12" y2="12" />
                    <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg>
                <h2 style="
              color: #111827;
              font-size: 1.5rem;
              margin-bottom: 1rem;
            ">JavaScript Required</h2>
                <p style="
              color: #4b5563;
              line-height: 1.5;
              margin-bottom: 1rem;
            ">This application requires JavaScript to function. Please enable JavaScript in your browser settings to
                    continue.</p>
                <p style="
              color: #6b7280;
              font-size: 0.875rem;
            ">If you need assistance, please contact your on-site IT support team.</p>
            </div>
        </div>
    </noscript>

    <div class="header-container">
        <h1>Staff Kaartdijin Validator v0.5</h1><button class="help-button" onclick="openModal()">Help </button>
    </div>
    <div id="helpModal" class="modal">
        <div class="modal-content"><span class="close-modal" onclick="closeModal()">&times;
            </span>
            <h2>How to Get the Required Reports</h2>
            <div class="modal-section">
                <h3>Phonebook CSV</h3>
                <p>From SIS you need a Staff General Export CSV. Which can be found here:</br>1.
                    Admin>Utilities</br>2. Double click "General Staff Export" </br>3. Click Yes</br>4. Name & save
                    it somewhere you'll remember.</p>
            </div>
            <div class="modal-section">
                <h3>Staff Export CSV</h3>
                <p>From Ikon you need a Phonebook Export CSV for your school. </br>1. Go here: <a
                        href="https://apps.det.wa.edu.au/phd/search" target="_blank" rel="noopener noreferrer">https:
                        //apps.det.wa.edu.au/phd/search</a></br>
                    2. Look up your School Code or School Name in Department</br>3. Click Download
                    Results</br></br>(To include staff from shared sites you'll have to look up the other school in
                    the phonebook,
                    download the results and either merge the CSV or run it separately.)</p>
            </div>
        </div>
    </div>
    <div class="upload-container">
        <div class="file-inputs">
            <div class="file-drop-area" id="phonebookArea"><span class="upload-icon">📁</span>
                <h2>Upload Phonebook CSV</h2>
                <p>Drag & drop file here or click to select</p><input type="file" id="phonebookFile" accept=".csv">
                <div class="file-name" id="phonebookName"></div>
                <div class="file-error" id="phonebookError"></div>
            </div>
            <div class="file-drop-area" id="staffExportArea"><span class="upload-icon">📁</span>
                <h2>Upload Staff Export CSV</h2>
                <p>Drag & drop file here or click to select</p><input type="file" id="staffExportFile" accept=".csv">
                <div class="file-name" id="staffExportName"></div>
                <div class="file-error" id="staffExportError"></div>
            </div>
        </div>
        <div class="view-toggle">
            <label for="viewMode">Group by:</label>
            <select id="viewMode" onchange="switchView()">
                <option value="category">Category</option>
                <option value="staff">Staff Member</option>
            </select>
        </div>
    </div>
    <div class="results">
        <h2>Validation Results</h2>
        <div id="errorList"></div>
    </div>

    <script> // Global validation results storage
        // Global validation results storage
        let globalValidationResults = {
            errors: {},
            warnings: {},
            staffMap: new Map()
        };

        // Define required columns for each file type
        const requiredColumns = {
            phonebook: ['E-Number', 'First Name', 'Surname', 'Job Title', 'Department', 'Mobile', 'Phone', 'E-Mail'],
            staffExport: ['IDNumber', 'StaffType', 'FirstName', 'Surname', 'JoinDate', 'LeaveDate']
        };

        function updateViewToggleHTML() {
            const container = document.querySelector('.view-toggle');
            if (container) {
                container.innerHTML = `
            <label for="viewMode">Group by:</label>
            <select id="viewMode" onchange="switchView()">
                <option value="category">Category</option>
                <option value="staff">Staff Member</option>
            </select>
        `;
            }
        }

        async function validateFileFormat(file, fileType) {
            if (!file) return { isValid: false, error: 'No file selected' };

            // Check file extension
            if (!file.name.toLowerCase().endsWith('.csv')) {
                return { isValid: false, error: 'File must be a CSV' };
            }

            try {
                const text = await readFileChunk(file, 8192);
                const lines = text.split(/\r?\n/);

                if (lines.length < 2) {
                    return { isValid: false, error: 'File appears to be empty' };
                }

                const headerLine = lines[0].replace(/\r$/, '');
                let headers = [];

                if (headerLine.includes('"')) {
                    let inQuotes = false;
                    let currentHeader = '';

                    for (let char of headerLine) {
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            headers.push(currentHeader.trim());
                            currentHeader = '';
                        } else {
                            currentHeader += char;
                        }
                    }
                    headers.push(currentHeader.trim());
                } else {
                    headers = headerLine.split(',').map(h => h.trim());
                }

                const requiredCols = requiredColumns[fileType];
                const missingColumns = requiredCols.filter(col => !headers.includes(col));

                if (missingColumns.length > 0) {
                    return {
                        isValid: false,
                        error: `Missing required columns: ${missingColumns.join(', ')}`
                    };
                }

                return { isValid: true };
            } catch (error) {
                console.error('File validation error:', error);
                return { isValid: false, error: 'Error reading file: ' + error.message };
            }
        }

        function readFileChunk(file, size) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                const blob = file.slice(0, size);
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(blob);
            });
        }

        async function handleFileUpload(file, areaId, errorId, fileType) {
            const dropArea = document.getElementById(areaId);
            const errorDiv = document.getElementById(errorId);

            dropArea.classList.remove('valid', 'invalid');
            errorDiv.textContent = '';

            if (file) {
                const validation = await validateFileFormat(file, fileType);
                if (validation.isValid) {
                    dropArea.classList.add('valid');
                } else {
                    dropArea.classList.add('invalid');
                    errorDiv.textContent = validation.error;
                }
                return validation.isValid;
            }
            return false;
        }

        function setupDragAndDrop(dropAreaId, fileInputId, fileNameId, errorId, fileType) {
            const dropArea = document.getElementById(dropAreaId);
            const fileInput = document.getElementById(fileInputId);
            const fileName = document.getElementById(fileNameId);

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    if (!dropArea.classList.contains('invalid')) {
                        dropArea.classList.add('dragover');
                    }
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.remove('dragover');
                });
            });

            dropArea.addEventListener('drop', async (e) => {
                const file = e.dataTransfer.files[0];
                await handleFile(file);
            });

            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                await handleFile(file);
            });

            async function handleFile(file) {
                if (file) {
                    fileName.textContent = file.name;
                    const isValid = await handleFileUpload(file, dropAreaId, errorId, fileType);
                    if (isValid) {
                        fileInput.files = new DataTransfer().files;
                        const newFileList = new DataTransfer();
                        newFileList.items.add(file);
                        fileInput.files = newFileList.files;
                    } else {
                        fileInput.value = '';
                        fileName.textContent = '';
                    }
                    await checkFilesAndValidate();
                }
            }
        }

        async function checkFilesAndValidate() {
            const phonebookFile = document.getElementById('phonebookFile').files[0];
            const staffExportFile = document.getElementById('staffExportFile').files[0];

            if (phonebookFile && staffExportFile) {
                const phonebookValid = await validateFileFormat(phonebookFile, 'phonebook');
                const staffExportValid = await validateFileFormat(staffExportFile, 'staffExport');

                if (phonebookValid.isValid && staffExportValid.isValid) {
                    validateFiles();
                }
            }
        }

        function parseCSV(text) {
            text = text.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n');
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const result = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue;

                const values = [];
                let inQuotes = false;
                let currentValue = '';

                for (let char of line) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim());

                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                result.push(obj);
            }
            return result;
        }

        function normalizeString(str) {
            if (!str) return '';
            return str.toLowerCase().trim();
        }

        function validateENumber(eNumber) {
            if (!eNumber) return false;
            eNumber = eNumber.trim();
            const ePattern = /^E\d{7}$/;
            const evPattern = /^EV\d{6}$/;
            return ePattern.test(eNumber) || evPattern.test(eNumber);
        }

        function validateDate(dateStr) {
            if (!dateStr) return true;
            dateStr = dateStr.trim();
            if (dateStr === '') return true;

            const [day, month, year] = dateStr.split('/').map(num => parseInt(num, 10));
            if (!day || !month || !year) return false;

            const date = new Date(year, month - 1, day);
            const now = new Date();

            date.setHours(0, 0, 0, 0);
            now.setHours(0, 0, 0, 0);

            return date <= now;
        }

        function addMessage(message, type, category) {
            const categoryDiv = document.getElementById(category) || createCategory(category, type);
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            categoryDiv.querySelector('.message-list').appendChild(messageDiv);
        }

        function createCategory(category, type) {
            const errorList = document.getElementById('errorList');
            const categoryDiv = document.createElement('div');
            categoryDiv.id = category;
            categoryDiv.className = `${type}-category`;

            const title = document.createElement('h3');
            title.textContent = category;

            const messageListDiv = document.createElement('div');
            messageListDiv.className = 'message-list';

            categoryDiv.appendChild(title);
            categoryDiv.appendChild(messageListDiv);
            errorList.appendChild(categoryDiv);

            return categoryDiv;
        }

        function addSuccess(message) {
            const errorList = document.getElementById('errorList');
            const success = document.createElement('div');
            success.className = 'success';
            success.textContent = message;
            errorList.appendChild(success);
        }

        async function validateFiles() {
            const errorList = document.getElementById('errorList');
            errorList.innerHTML = '';

            const phonebookFile = document.getElementById('phonebookFile').files[0];
            const staffExportFile = document.getElementById('staffExportFile').files[0];

            if (!phonebookFile || !staffExportFile) {
                addMessage('Please upload both CSV files', 'error', 'Upload Errors');
                return;
            }

            try {
                const phonebookData = parseCSV(await phonebookFile.text());
                const staffExportData = parseCSV(await staffExportFile.text());

                // Reset global validation results
                globalValidationResults = {
                    errors: {
                        'E-Number Format Errors': [],
                        'Date Validation Errors': [],
                        'Staff Type Errors': []
                    },
                    warnings: {
                        'Name Mismatch Warnings': []
                    },
                    staffMap: new Map()
                };

                const phonebookMap = new Map();

                phonebookData.forEach(entry => {
                    const eNumber = entry['E-Number']?.trim();
                    if (eNumber) {
                        phonebookMap.set(eNumber, {
                            firstName: normalizeString(entry['First Name']),
                            surname: normalizeString(entry['Surname'])
                        });
                    }
                });

                staffExportData.forEach(staff => {
                    const idNumber = staff.IDNumber?.trim();
                    if (!idNumber) return;

                    if (!globalValidationResults.staffMap.has(idNumber)) {
                        globalValidationResults.staffMap.set(idNumber, {
                            name: `${staff.FirstName} ${staff.Surname}`,
                            errors: [],
                            warnings: []
                        });
                    }

                    if (!validateENumber(idNumber)) {
                        const error = `Invalid E-Number format: ${idNumber} (Invalid format or erroneous space)`;
                        globalValidationResults.errors['E-Number Format Errors'].push(error);
                        globalValidationResults.staffMap.get(idNumber).errors.push({
                            category: 'E-Number Format',
                            message: error
                        });
                    }

                    const phonebookEntry = phonebookMap.get(idNumber);
                    if (phonebookEntry) {
                        const staffFirstName = normalizeString(staff.FirstName);
                        const staffSurname = normalizeString(staff.Surname);

                        if (staffFirstName !== phonebookEntry.firstName) {
                            const warning = `Name mismatch for ${idNumber}: First name in staff export (${staff.FirstName}) doesn't match phonebook (${phonebookEntry.firstName})`;
                            globalValidationResults.warnings['Name Mismatch Warnings'].push(warning);
                            globalValidationResults.staffMap.get(idNumber).warnings.push({
                                category: 'Name Mismatch',
                                message: warning
                            });
                        }

                        if (staffSurname !== phonebookEntry.surname) {
                            const warning = `Name mismatch for ${idNumber}: Surname in staff export (${staff.Surname}) doesn't match phonebook (${phonebookEntry.surname})`;
                            globalValidationResults.warnings['Name Mismatch Warnings'].push(warning);
                            globalValidationResults.staffMap.get(idNumber).warnings.push({
                                category: 'Name Mismatch',
                                message: warning
                            });
                        }
                    }

                    if (staff.JoinDate && !validateDate(staff.JoinDate)) {
                        const error = `Invalid Join Date for ${idNumber}: ${staff.JoinDate} (must be in the past)`;
                        globalValidationResults.errors['Date Validation Errors'].push(error);
                        globalValidationResults.staffMap.get(idNumber).errors.push({
                            category: 'Date Validation',
                            message: error
                        });
                    }

                    if (staff.LeaveDate && staff.LeaveDate.trim() !== '') {
                        const error = `Leave Date present for ${idNumber}: ${staff.LeaveDate} (Can't have a leave date.)`;
                        globalValidationResults.errors['Date Validation Errors'].push(error);
                        globalValidationResults.staffMap.get(idNumber).errors.push({
                            category: 'Date Validation',
                            message: error
                        });
                    }

                    if (!staff.StaffType || staff.StaffType.trim() === '') {
                        const error = `Staff Type is blank for ${idNumber}`;
                        globalValidationResults.errors['Staff Type Errors'].push(error);
                        globalValidationResults.staffMap.get(idNumber).errors.push({
                            category: 'Staff Type',
                            message: error
                        });
                    }
                });

                displayResults();
            } catch (error) {
                addMessage('Error processing files: ' + error.message, 'error', 'System Errors');
                console.error(error);
            }
        }


        function initializeViewMode() {
            const savedView = localStorage.getItem('validatorViewMode');
            const viewModeSelect = document.getElementById('viewMode');

            if (savedView) {
                viewModeSelect.value = savedView;
            }

            // Initial display using saved or default view
            displayResults();
        }

        function displayResults() {
            const viewMode = document.getElementById('viewMode').value || 'category'; // Default to category if not set
            const errorList = document.getElementById('errorList');
            errorList.innerHTML = '';

            // Check if validation has been performed (i.e., if files have been uploaded)
            const hasValidationResults = Object.keys(globalValidationResults.errors).length > 0 ||
                Object.keys(globalValidationResults.warnings).length > 0 ||
                globalValidationResults.staffMap.size > 0;

            if (!hasValidationResults) {
                // Don't show any message if no validation has been performed
                return;
            }

            const totalErrors = Object.values(globalValidationResults.errors).reduce((sum, arr) => sum + arr.length, 0);
            const totalWarnings = Object.values(globalValidationResults.warnings).reduce((sum, arr) => sum + arr.length, 0);

            if (totalErrors === 0 && totalWarnings === 0) {
                addSuccess('No validation issues found! All records are valid.');
                return;
            }

            // Create summary container
            const summaryContainer = document.createElement('div');
            summaryContainer.className = 'summary-container';

            if (totalErrors > 0) {
                const totalErrorsDiv = document.createElement('div');
                totalErrorsDiv.className = 'total-summary total-errors';
                totalErrorsDiv.textContent = `Total errors found: ${totalErrors}`;
                summaryContainer.appendChild(totalErrorsDiv);
            }

            if (totalWarnings > 0) {
                const totalWarningsDiv = document.createElement('div');
                totalWarningsDiv.className = 'total-summary total-warnings';
                totalWarningsDiv.textContent = `Total warnings found: ${totalWarnings}`;
                summaryContainer.appendChild(totalWarningsDiv);
            }

            errorList.appendChild(summaryContainer);

            if (viewMode === 'category') {
                displayCategoryView();
            } else {
                displayStaffView();
            }
        }

        function displayCategoryView() {
            // Display errors by category
            for (const [category, categoryErrors] of Object.entries(globalValidationResults.errors)) {
                if (categoryErrors.length > 0) {
                    categoryErrors.forEach(error => {
                        addMessage(error, 'error', category);
                    });
                }
            }

            // Display warnings by category
            for (const [category, categoryWarnings] of Object.entries(globalValidationResults.warnings)) {
                if (categoryWarnings.length > 0) {
                    categoryWarnings.forEach(warning => {
                        addMessage(warning, 'warning', category);
                    });
                }
            }
        }

        function displayStaffView() {
            const errorList = document.getElementById('errorList');

            // Create grid container
            const staffGrid = document.createElement('div');
            staffGrid.className = 'staff-grid';
            errorList.appendChild(staffGrid);

            // Sort staff members prioritizing those with errors, then by total issues
            const sortedStaff = Array.from(globalValidationResults.staffMap.entries()).sort((a, b) => {
                // First prioritize staff with errors
                if (a[1].errors.length > 0 && b[1].errors.length === 0) return -1;
                if (a[1].errors.length === 0 && b[1].errors.length > 0) return 1;

                // If both have errors or both don't have errors, sort by total number of issues
                const aTotal = a[1].errors.length + a[1].warnings.length;
                const bTotal = b[1].errors.length + b[1].warnings.length;
                if (aTotal !== bTotal) return bTotal - aTotal;

                // If same total, prioritize the one with more errors
                return b[1].errors.length - a[1].errors.length;
            });

            sortedStaff.forEach(([idNumber, staffData]) => {
                if (staffData.errors.length === 0 && staffData.warnings.length === 0) return;

                const staffGroup = document.createElement('div');
                staffGroup.className = 'staff-group';

                const staffHeader = document.createElement('h3');
                staffHeader.textContent = `${staffData.name} (${idNumber})`;
                staffGroup.appendChild(staffHeader);

                const staffIssues = document.createElement('div');
                staffIssues.className = 'staff-issues';

                // First add errors section if there are errors
                if (staffData.errors.length > 0) {
                    const errorsSection = document.createElement('div');
                    errorsSection.className = 'staff-issues-section';

                    staffData.errors.forEach(error => {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error';
                        errorDiv.textContent = error.message;
                        errorsSection.appendChild(errorDiv);
                    });

                    staffIssues.appendChild(errorsSection);
                }

                // Then add warnings section if there are warnings
                if (staffData.warnings.length > 0) {
                    const warningsSection = document.createElement('div');
                    warningsSection.className = 'staff-issues-section';

                    staffData.warnings.forEach(warning => {
                        const warningDiv = document.createElement('div');
                        warningDiv.className = 'warning';
                        warningDiv.textContent = warning.message;
                        warningsSection.appendChild(warningDiv);
                    });

                    staffIssues.appendChild(warningsSection);
                }

                staffGroup.appendChild(staffIssues);
                staffGrid.appendChild(staffGroup);
            });
        }

        function switchView() {
            const viewMode = document.getElementById('viewMode').value;
            // Save the selection to localStorage
            localStorage.setItem('validatorViewMode', viewMode);
            displayResults();
        }


        function openModal() {
            document.getElementById('helpModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('helpModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        // Close modal when pressing ESC
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Initialize drag and drop with file type specification
        setupDragAndDrop('phonebookArea', 'phonebookFile', 'phonebookName', 'phonebookError', 'phonebook');
        setupDragAndDrop('staffExportArea', 'staffExportFile', 'staffExportName', 'staffExportError', 'staffExport');

        document.addEventListener('DOMContentLoaded', function () {
            initializeViewMode();
        });
    </script>
</body>

</html>
